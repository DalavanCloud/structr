<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>$title</title>
    $headElements
    <link href="$contextPath/css/smoothness/jquery-ui-1.8.4.custom.css" rel="stylesheet"  type="text/css"/>
    <link href="$contextPath/css/structr.css" rel="stylesheet" type="text/css">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <!--meta name="viewport" content="width=1024px, minimum-scale=1.0, maximum-scale=1.0" /-->
  </head>

  <body>
    #if ($renderMode != "inline")
    <div id="header">

      <!--            <div class="structr"><span class="structrCap">s</span>tructr</div>-->
      <div class="mainLink">$homeLink</div>
      <div class="mainLink">$usersLink</div>
      <div class="mainLink">$maintenanceLink</div>


      #if ($userName)
      <div class="util">
        <img alt="$userName" title="$userName" src="$contextPath/images/user.png"> $userName
        <span class="spacer">&nbsp;</span>
        <img alt="Logout" title="Logout" src="$contextPath/images/door_out.png"> $logoutLink
      </div>
      #end

      #if ($renderMode != "inline" && $simpleSearchPanel)
      <div class="search">$simpleSearchPanel</div>
      #end

    </div>
    #end

    <div style="clear: both"></div>

    #if ($errorMsg && $errorMsg != "")
    <div id="msg" class="errorMsg">$errorMsg</div>
    #end
    #if ($okMsg && $okMsg != "")
    <div id="msg" class="okMsg">$okMsg</div>
    #end
    #if ($warnMsg && $warnMsg != "")
    <div id="msg" class="warnMsg">$warnMsg</div>
    #end

    <div id="main">
      #if ($renderMode != "inline")
      #if ($nodeTreePanel)
      $nodeTreePanel
      #end
      #end


      #if ($renderMode != "inline")
      <div class="contentBox tabArea">
        #else
        <div class="tabArea tabAreaInline">
          #end

          <h2 class="header">
            #if ($node.name && $node.name != "")
            <img alt="$node.name"  src="$context/$node.iconSrc"> $node.name
            #end
          </h2>

          #if ($actionsPanel)
          <div class="actionsPanel">
            $actionsPanel
          </div>
          #end


          <div id="tabs" class="ui-tabs">

            <ul>
              #if ($renditionPanel)
              <li><a href="#rendition-tab"><span>View</span></a></li>

              ##if ($node.type != "File")
              <li><a href="#source-tab"><span>Source</span></a></li>
              ##end
              #end

              #if ($searchResultsPanel)
              <li><a href="#search-tab"><span>Search Results</span></a></li>
              #end

              #if ($reportPanel)
              <li><a href="#report-tab"><span>Reports</span></a></li>
              #end

              #if ($editContentForm)
              <li><a href="#content-tab"><span>Content</span></a></li>
              #end

              #if ($editChildNodesPanel)
              <li><a href="#childnodes-tab"><span>Child Nodes</span></a></li>
              #end

              #if ($editPropertiesPanel)
              <li><a href="#properties-tab"><span>Properties</span></a></li>
              #end

              #if ($editVisibilityPanel)
              <li><a href="#visibility-tab"><span>Visibility</span></a></li>
              #end

              #if ($editRelationshipsPanel)
              <li><a href="#relationships-tab"><span>Relationships</span></a></li>
              #end

              #if ($editSecurityPanel)
              <li><a href="#security-tab"><span>Security</span></a></li>
              #end

              #if ($cloudPanel)
              <li><a href="#cloud-tab"><span>Cloud</span></a></li>
              #end
            </ul>

            <div style="clear: both"></div>

            #if ($renditionPanel)
            $renditionPanel
            #end

            $jsElements

            <script src="$context/js/jquery-1.6.1.min.js" type="text/javascript"></script>
            <script src="$context/js/jquery.ba-urlinternal.min.js" type="text/javascript"></script>
            <script src="$context/js/jquery.cookies.2.2.0.min.js" type="text/javascript"></script>
            <script src="$context/js/jquery.blockUI.js" type="text/javascript" ></script>
            <script src="$context/js/jquery-ui-1.8.12.custom.min.js" type="text/javascript" ></script>
            <script src="$context/js/admin.js" type="text/javascript"></script>

            #if ($editContentForm)
            <div id="content-tab" class="ui-tabs-hide">

              <div class="body">
                #parse($path)
              </div>

            </div>
            #end

            #if ($searchResultsPanel)
            <div id="search-tab" class="ui-tabs-hide">
              <div class="body">
                #parse($path)
              </div>
            </div>
            #end

            #if ($reportPanel)
            <div id="report-tab" class="ui-tabs-hide">
              #parse($path)
            </div>
            #end

            #if ($editChildNodesPanel)
            $editChildNodesPanel
            #end

            #if ($editPropertiesPanel)
            $editPropertiesPanel
            #end

            #if ($editVisibilityPanel)
            $editVisibilityPanel
            #end

            #if ($editRelationshipsPanel)
            $editRelationshipsPanel
            #end

            #if ($editSecurityPanel)
            $editSecurityPanel
            #end

            #if ($maintenancePanel)
            $maintenancePanel
            #end

            #if ($cloudPanel)
            $cloudPanel
            #end
          </div><!-- .body -->

        </div><!-- #tabs -->

      </div><!-- .tabArea -->

      <div style="clear: both"></div>


      <script type="text/javascript">
        jQuery.noConflict();

        jQuery(window).resize(function() {
          setWindowHeightAndWidth(true);
        });

        window.onbeforeunload = function () {
          //alert(jQuery("#treeArea .body").scrollTop());
          jQuery.cookies.set("scrollTree", jQuery(".treeArea .body").scrollTop());
          //jQuery.cookies.set("scrollMain", jQuery(".tabArea .body").scrollTop());
          jQuery.cookies.set("scrollCode", jQuery(".tabArea .CodeMirror-wrapping iframe").contents().scrollTop());
          //alert(jQuery("#tabArea .CodeMirror-wrapping iframe").contents().scrollTop());
          jQuery.cookies.set("scrollIframe", jQuery("#rendition-tab iframe").contents().scrollTop());
          //alert(jQuery("#rendition-tab iframe").contents().scrollTop());
          jQuery.cookies.set("scrollTextarea", jQuery("#source-tab textarea").scrollTop());
        }

        jQuery(document).ready(function() {

          jQuery("#tabs").tabs();

          setWindowHeightAndWidth(false);

          jQuery('.unblock').click(function() {
            jQuery.unblockUI({
              fadeOut: 0
            });
          });

          jQuery('#toggleNewNodeForm').click(function() {
            showNewNodePanel();
          });

          #if ($newNodeFormIsInvalid)
            showNewNodePanel();
          #end


          jQuery('#toggleUploadForm').click(function() {
            showUploadPanel();
          });

          #if ($uploadFormIsInvalid)
            showUploadPanel();
          #end

          jQuery('#toggleExtractNodeForm').click(function() {
            showExtractNodePanel();
          });

          #if ($extractNodeFormIsInvalid)
            showExtractNodePanel();
          #end

          jQuery('#toggleCopyNodeForm').click(function() {
            showCopyNodePanel()
          });

          #if ($copyNodeFormIsInvalid)
            showCopyNodePanel();
          #end

          jQuery('#toggleMoveNodeForm').click(function() {
            showMoveNodePanel()
          });

          #if ($moveNodeFormIsInvalid)
            showMoveNodePanel();
          #end

          jQuery('#toggleNewRelationshipForm').click(function() {
            showNewRelationshipPanel();
          });

          #if ($newRelationshipFormIsInvalid)
            showNewRelationshipPanel();
          #end

          jQuery('#toggleEditPropertiesForm').click(function() {
            showEditPropertiesPanel()
          });

          #if ($editPropertiesFormIsInvalid)
            showNewRelationshipPanel();
          #end

          jQuery('#toggleDeleteNodeForm').click(function() {
            showDeleteNodePanel()
          });

          #if ($deleteNodeFormIsInvalid)
            showDeleteNodePanel();
          #end


          var treeElements = jQuery('#tree li a').not('.spacer');
          jQuery.each(treeElements, function(i, el) {
        
            //console.log(jQuery('span a', el).attr('href'));

            jQuery(el).draggable({
              distance:    '5',
              //axis:        'y',
              containment: '#tree',
              //cursor:      'crosshair',
              //cursorAt:    { top: 0, left: 0 },
              //handle:      'a',
              helper:      'clone',
              scroll:      'true',
              //opacity:     0.8,
              revert:      'invalid'
              //snap:        true
              //snapMode:    'both'
            }).data('nodeId', getParam('nodeId', jQuery(el).attr('href')));

            jQuery(el).droppable({
              accept: function(draggable) {
                return !(draggable.closest('li').find(el).length > 0);
              },
              greedy: true,
              tolerance: 'pointer',
              hoverClass: 'droptarget',
              drop: function(event, ui) {
                //              console.log(ui.draggable);
                //              console.log('Source node id: ' + jQuery(ui.draggable).data('nodeId'));
                //              console.log(jQuery(this));
                //              console.log(jQuery(event.srcElement));
                //              console.log('Target node id: ' + getParam('nodeId', jQuery(this).attr('href')));
                var dragged = jQuery(ui.draggable);
                var dropTarget = jQuery(this);
                
                //console.log(dragged.closest('li').find(dropTarget));
                
                if (!dragged.closest('li').find(dropTarget).length > 0) {
                  console.log('move');
                  var targetNodeId = getParam('nodeId', dropTarget.attr('href'));
                  //jQuery(this).attr('href', '#');
                  //submitMoveNodeForm(jQuery(ui.draggable).data('nodeId'), targetNodeId);
                } else {
                  console.log('move impossible');
                }
              }
            });
          
            //          console.log('Tree element ' + i + ': ' + li);
          }); 


        });
      
        function getParam(name,url) {
          return decodeURI(
          (RegExp(name + '=' + '(.+?)(&|$)').exec(url)||[,null])[1]
        );
        }
      
        function submitMoveNodeForm(sourceId, targetId) {
          console.log('Move node ' + sourceId + ' to ' + targetId);
          jQuery('#moveNodeForm_sourceNodeId').val(sourceId);
          jQuery('#moveNodeForm_newParentNodeId').val(targetId);
          jQuery('#moveNodeForm_moveNode').val(' Move node ');
          //jQuery('#moveNodeForm').attr('method', 'GET');
          jQuery('#moveNodeForm').submit();
          //        console.log(document.forms['moveNodeForm']);
          //        document.forms['moveNodeForm'].submit();
        } 
      
      </script>
      <style text="text/css">
        #tree .highlight {
          background-color: #fea;
        }
        #treeArea .body {
          position: relative;
        }
      </style>
    </div><!-- #main -->

  </body>
</html>